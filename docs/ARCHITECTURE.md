# ShopZone Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Layer                            â”‚
â”‚                    (Web Browser / Mobile App)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ HTTP/HTTPS
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Gateway Layer                         â”‚
â”‚                    (Spring Boot Application)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Auth      â”‚  â”‚  Product    â”‚  â”‚   Order     â”‚             â”‚
â”‚  â”‚ Controller  â”‚  â”‚ Controller  â”‚  â”‚ Controller  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Payment    â”‚  â”‚  Webhook    â”‚  â”‚   Admin     â”‚             â”‚
â”‚  â”‚ Controller  â”‚  â”‚ Controller  â”‚  â”‚ Controller  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Review     â”‚  â”‚   Search    â”‚  â”‚    Sync     â”‚             â”‚
â”‚  â”‚ Controller  â”‚  â”‚ Controller  â”‚  â”‚  Service    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Admin      â”‚  â”‚ Admin       â”‚  â”‚  Admin User â”‚             â”‚
â”‚  â”‚ Dashboard ðŸ†•â”‚  â”‚ Report   ðŸ†• â”‚  â”‚ ControllerðŸ†•â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  (Week 7)   â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Auth      â”‚  â”‚  Product    â”‚  â”‚   Order     â”‚             â”‚
â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Payment    â”‚  â”‚  Refund     â”‚  â”‚  Stripe     â”‚             â”‚
â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Review     â”‚  â”‚   Search    â”‚  â”‚    Sync     â”‚             â”‚
â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Email   ðŸ†• â”‚  â”‚ DashboardðŸ†• â”‚  â”‚  Report  ðŸ†•â”‚             â”‚
â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  (Week 7)   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â–¼                â–¼                â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚  MongoDB    â”‚  â”‚   Redis     â”‚  â”‚ Stripe â”‚ â”‚
â”‚  â”‚   Users     â”‚  â”‚  Products   â”‚  â”‚   Cart      â”‚  â”‚  API   â”‚ â”‚
â”‚  â”‚   Orders    â”‚  â”‚ Categories  â”‚  â”‚  Wishlist   â”‚  â”‚        â”‚ â”‚
â”‚  â”‚  Payments   â”‚  â”‚             â”‚  â”‚  Sessions   â”‚  â”‚        â”‚ â”‚
â”‚  â”‚  Addresses  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚        â”‚ â”‚
â”‚  â”‚  Reviews    â”‚  â”‚             â”‚  â”‚             â”‚  â”‚        â”‚ â”‚
â”‚  â”‚ EmailLogsðŸ†• â”‚  â”‚             â”‚  â”‚             â”‚  â”‚        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Elasticsearch                        â”‚   â”‚
â”‚  â”‚                    Product Search Index                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  Mailtrap SMTP ðŸ†• (Week 7)              â”‚   â”‚
â”‚  â”‚              Email Testing / Delivery Service           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Architecture

### Polyglot Persistence Strategy

We use different databases for different purposes:

| Database | Use Case | Why |
|----------|----------|-----|
| **PostgreSQL** | Users, Orders, Payments, Addresses, Reviews, Email Logs ðŸ†• | ACID compliance, relational data, transactions |
| **MongoDB** | Products, Categories | Flexible schema, nested data, fast reads |
| **Redis** | Cart, Wishlist, Sessions | In-memory speed, TTL support, temporary data |
| **Stripe** | Payment Processing | PCI compliance, secure payment handling |
| **Elasticsearch** | Product Search | Full-text search, filters, autocomplete |
| **Mailtrap** ðŸ†• | Email Testing | Safe email testing without sending to real inboxes |

---

## PostgreSQL Schema

### Users Table
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    phone VARCHAR(20),
    role VARCHAR(20) DEFAULT 'CUSTOMER',
    email_verified BOOLEAN DEFAULT FALSE,
    enabled BOOLEAN DEFAULT TRUE,
    locked BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### Addresses Table
```sql
CREATE TABLE addresses (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    full_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    address_line1 VARCHAR(255) NOT NULL,
    address_line2 VARCHAR(255),
    city VARCHAR(100) NOT NULL,
    state VARCHAR(100) NOT NULL,
    postal_code VARCHAR(20) NOT NULL,
    country VARCHAR(100) NOT NULL,
    landmark VARCHAR(255),
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### Orders Table
```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY,
    order_number VARCHAR(20) UNIQUE NOT NULL,
    user_id UUID REFERENCES users(id),
    user_email VARCHAR(255),
    user_full_name VARCHAR(200),
    
    -- Status
    status VARCHAR(20) NOT NULL,
    payment_status VARCHAR(20) NOT NULL,
    
    -- Shipping Address Snapshot
    shipping_address_id UUID,
    shipping_full_name VARCHAR(100),
    shipping_phone_number VARCHAR(20),
    shipping_address_line1 VARCHAR(255),
    shipping_address_line2 VARCHAR(255),
    shipping_city VARCHAR(100),
    shipping_state VARCHAR(100),
    shipping_postal_code VARCHAR(20),
    shipping_country VARCHAR(100),
    shipping_landmark VARCHAR(255),
    
    -- Shipping Info
    tracking_number VARCHAR(100),
    shipping_carrier VARCHAR(50),
    
    -- Amounts
    subtotal DECIMAL(10,2),
    tax_rate DECIMAL(5,4),
    tax_amount DECIMAL(10,2),
    shipping_cost DECIMAL(10,2),
    discount_amount DECIMAL(10,2),
    total_amount DECIMAL(10,2),
    amount_refunded DECIMAL(10,2),
    
    -- Notes
    customer_notes TEXT,
    admin_notes TEXT,
    cancellation_reason TEXT,
    cancelled_by VARCHAR(20),
    
    -- Payment (Stripe)
    payment_method VARCHAR(50),
    payment_id VARCHAR(100),
    stripe_payment_intent_id VARCHAR(100),
    stripe_charge_id VARCHAR(100),
    receipt_url VARCHAR(500),
    
    -- Timestamps
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    paid_at TIMESTAMP,
    confirmed_at TIMESTAMP,
    shipped_at TIMESTAMP,
    delivered_at TIMESTAMP,
    cancelled_at TIMESTAMP
);
```

### Order Items Table
```sql
CREATE TABLE order_items (
    id UUID PRIMARY KEY,
    order_id UUID REFERENCES orders(id),
    
    -- Product Snapshot
    product_id VARCHAR(50),
    product_name VARCHAR(255),
    product_slug VARCHAR(255),
    product_sku VARCHAR(100),
    product_image VARCHAR(500),
    product_brand VARCHAR(100),
    
    -- Pricing
    unit_price DECIMAL(10,2),
    discount_price DECIMAL(10,2),
    effective_price DECIMAL(10,2),
    quantity INTEGER,
    total_price DECIMAL(10,2)
);
```

### Payments Table
```sql
CREATE TABLE payments (
    id UUID PRIMARY KEY,
    
    -- Order Reference
    order_id VARCHAR(50) NOT NULL,
    order_number VARCHAR(20) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    
    -- Stripe References
    stripe_payment_intent_id VARCHAR(100) UNIQUE,
    stripe_charge_id VARCHAR(100),
    stripe_customer_id VARCHAR(100),
    client_secret VARCHAR(500),
    
    -- Payment Details
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    status VARCHAR(30) NOT NULL,
    payment_method VARCHAR(30),
    card_last_four VARCHAR(4),
    card_brand VARCHAR(20),
    
    -- Failure Information
    failure_code VARCHAR(100),
    failure_message VARCHAR(500),
    
    -- Refund Information
    amount_refunded DECIMAL(10,2) DEFAULT 0,
    stripe_refund_id VARCHAR(100),
    refund_reason VARCHAR(500),
    
    -- Metadata
    receipt_url VARCHAR(500),
    statement_descriptor VARCHAR(22),
    
    -- Timestamps
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    paid_at TIMESTAMP,
    refunded_at TIMESTAMP,
    
    -- Indexes
    INDEX idx_payment_order_id (order_id),
    INDEX idx_payment_intent_id (stripe_payment_intent_id),
    INDEX idx_payment_status (status),
    INDEX idx_payment_user_id (user_id)
);
```

### Reviews Table
```sql
CREATE TABLE reviews (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id) NOT NULL,
    product_id VARCHAR(50) NOT NULL,
    
    -- Review Content
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    title VARCHAR(100),
    comment TEXT,
    
    -- Verification
    verified_purchase BOOLEAN DEFAULT FALSE,
    order_number VARCHAR(20),
    
    -- Engagement
    helpful_count INTEGER DEFAULT 0,
    
    -- Timestamps
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    
    -- Constraints
    CONSTRAINT uk_user_product_review UNIQUE (user_id, product_id),
    
    -- Indexes
    INDEX idx_review_product (product_id),
    INDEX idx_review_user (user_id),
    INDEX idx_review_rating (rating),
    INDEX idx_review_created (created_at)
);
```

### Email Logs Table ðŸ†• (Week 7)
```sql
CREATE TABLE email_logs (
    id UUID PRIMARY KEY,
    
    -- Recipient
    user_id UUID REFERENCES users(id),
    recipient_email VARCHAR(255) NOT NULL,
    
    -- Email Details
    email_type VARCHAR(50) NOT NULL,
    subject VARCHAR(500),
    
    -- Status
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    error_message TEXT,
    
    -- Reference
    order_number VARCHAR(20),
    
    -- Timestamps
    created_at TIMESTAMP,
    sent_at TIMESTAMP,
    
    -- Indexes
    INDEX idx_email_log_user (user_id),
    INDEX idx_email_log_status (status),
    INDEX idx_email_log_type (email_type)
);
```

---

## MongoDB Schema

### Products Collection
```javascript
{
  "_id": ObjectId,
  "name": "iPhone 15 Pro",
  "slug": "iphone-15-pro",
  "description": "Latest Apple smartphone",
  "price": 999.99,
  "discountPrice": 949.99,
  "stock": 100,
  "sku": "IPHONE-15-PRO",
  "brand": "Apple",
  "categoryId": ObjectId,
  "images": [
    {
      "url": "https://cloudinary.com/...",
      "publicId": "products/abc123",
      "isPrimary": true
    }
  ],
  "tags": ["smartphone", "apple", "5g"],
  "specifications": {
    "color": "Space Black",
    "storage": "256GB"
  },
  "active": true,
  "averageRating": 4.5,
  "reviewCount": 128,
  "createdAt": ISODate,
  "updatedAt": ISODate
}
```

### Categories Collection
```javascript
{
  "_id": ObjectId,
  "name": "Smartphones",
  "slug": "smartphones",
  "description": "Mobile phones and accessories",
  "parentId": ObjectId | null,
  "imageUrl": "https://cloudinary.com/...",
  "active": true,
  "createdAt": ISODate,
  "updatedAt": ISODate
}
```

---

## Elasticsearch Schema

### Products Index
```javascript
{
  "mappings": {
    "properties": {
      "id": { "type": "keyword" },
      "name": { "type": "text", "analyzer": "standard" },
      "description": { "type": "text", "analyzer": "standard" },
      "sku": { "type": "keyword" },
      "slug": { "type": "keyword" },
      "brand": { "type": "keyword" },
      "price": { "type": "double" },
      "salePrice": { "type": "double" },
      "stock": { "type": "integer" },
      "active": { "type": "boolean" },
      "categoryId": { "type": "keyword" },
      "categoryName": { "type": "keyword" },
      "categorySlug": { "type": "keyword" },
      "tags": { "type": "keyword" },
      "images": { "type": "keyword" },
      "averageRating": { "type": "double" },
      "reviewCount": { "type": "integer" },
      "createdAt": { "type": "date" },
      "updatedAt": { "type": "date" }
    }
  }
}
```

---

## Redis Data Structure

### Cart
```
Key: cart:{userId}
Type: String (JSON)
TTL: 30 days

{
  "userId": "uuid",
  "items": [
    {
      "productId": "product-id",
      "productName": "iPhone 15",
      "quantity": 2,
      "unitPrice": 999.99,
      "effectivePrice": 949.99,
      "addedAt": "2026-01-21T10:00:00"
    }
  ],
  "updatedAt": "2026-01-21T10:30:00"
}
```

### Wishlist
```
Key: wishlist:{userId}
Type: String (JSON)
TTL: 90 days
```

---

## Email Notification Architecture ðŸ†• (Week 7)

### Email Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EMAIL NOTIFICATION FLOW                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Trigger Events                                                â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º User Registration â”€â”€â–º Welcome Email                  â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Payment Success â”€â”€â–º Order Confirmation Email         â”‚
â”‚       â”‚    (Webhook)                                            â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Status â†’ SHIPPED â”€â”€â–º Shipping Notification Email     â”‚
â”‚       â”‚    (Admin action)       (includes tracking number)      â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Status â†’ DELIVERED â”€â”€â–º Delivery Confirmation Email   â”‚
â”‚       â”‚    (Admin action)                                       â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Order Cancelled â”€â”€â–º Cancellation Email               â”‚
â”‚       â”‚                        (includes refund info)           â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€â–º Password Reset â”€â”€â–º Password Reset Email              â”‚
â”‚            (User request)      (includes reset link)            â”‚
â”‚                                                                 â”‚
â”‚   Processing                                                    â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚   EmailService      â”‚                                       â”‚
â”‚   â”‚   (@Async)          â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 1. Build context    â”‚                                       â”‚
â”‚   â”‚    (order details,  â”‚                                       â”‚
â”‚   â”‚     user info)      â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 2. Resolve template â”‚â”€â”€â”€â”€â”€â”€â”€â–º Thymeleaf Template Engine     â”‚
â”‚   â”‚    (HTML rendering) â”‚         src/main/resources/templates/ â”‚
â”‚   â”‚                     â”‚         email/*.html                  â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 3. Send via SMTP    â”‚â”€â”€â”€â”€â”€â”€â”€â–º Mailtrap (Dev) / Gmail (Prod) â”‚
â”‚   â”‚    (JavaMailSender) â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 4. Log result       â”‚â”€â”€â”€â”€â”€â”€â”€â–º PostgreSQL (email_logs)       â”‚
â”‚   â”‚    (SENT/FAILED)    â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Email Templates
```
src/main/resources/templates/email/
â”œâ”€â”€ welcome.html              # New user registration
â”œâ”€â”€ order-confirmation.html   # Order confirmed after payment
â”œâ”€â”€ order-shipped.html        # Order shipped with tracking
â”œâ”€â”€ order-delivered.html      # Order delivered
â”œâ”€â”€ order-cancelled.html      # Order cancelled (with refund info)
â””â”€â”€ password-reset.html       # Password reset link
```

### Email Provider Configuration
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EMAIL PROVIDER SWITCHING                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Development (Mailtrap):                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  host: sandbox.smtp.mailtrap.io                         â”‚   â”‚
â”‚   â”‚  port: 2525                                             â”‚   â”‚
â”‚   â”‚  All emails caught in Mailtrap inbox                    â”‚   â”‚
â”‚   â”‚  No real emails sent                                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   Production (Gmail/SendGrid/AWS SES):                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  host: smtp.gmail.com (or provider SMTP)                â”‚   â”‚
â”‚   â”‚  port: 587                                              â”‚   â”‚
â”‚   â”‚  Real emails delivered to recipients                    â”‚   â”‚
â”‚   â”‚  NO CODE CHANGES NEEDED - only application.yml          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Admin Dashboard Architecture ðŸ†• (Week 7)

### Dashboard Data Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ADMIN DASHBOARD FLOW                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   GET /api/admin/dashboard/stats                                â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚  DashboardService   â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚  Aggregates from:   â”‚                                       â”‚
â”‚   â”‚  â”œâ”€â”€ OrderRepositoryâ”‚â”€â”€â–º Order counts, revenue totals       â”‚
â”‚   â”‚  â”œâ”€â”€ UserRepository â”‚â”€â”€â–º User registration stats            â”‚
â”‚   â”‚  â”œâ”€â”€ ProductRepo    â”‚â”€â”€â–º Product/stock counts (MongoDB)     â”‚
â”‚   â”‚  â””â”€â”€ ReviewRepo     â”‚â”€â”€â–º Average ratings                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                 â”‚
â”‚   GET /api/admin/reports/sales?period=weekly                    â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚   ReportService     â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚  Generates:         â”‚                                       â”‚
â”‚   â”‚  â”œâ”€â”€ Daily revenue  â”‚â”€â”€â–º JPA aggregate queries              â”‚
â”‚   â”‚  â”œâ”€â”€ Weekly summary â”‚â”€â”€â–º Date range calculations            â”‚
â”‚   â”‚  â”œâ”€â”€ Monthly report â”‚â”€â”€â–º Period comparisons                 â”‚
â”‚   â”‚  â”œâ”€â”€ Category sales â”‚â”€â”€â–º Cross-database joins               â”‚
â”‚   â”‚  â””â”€â”€ Top customers  â”‚â”€â”€â–º User spending aggregation          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Search Architecture

### Search Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SEARCH FLOW                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   User Query: "gaming laptop"                                   â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚   â”‚SearchController â”‚                                           â”‚
â”‚   â”‚ GET /api/search â”‚                                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚            â”‚                                                    â”‚
â”‚            â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ ProductSearchServiceâ”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ â€¢ Build bool query  â”‚                                       â”‚
â”‚   â”‚ â€¢ Add filters       â”‚                                       â”‚
â”‚   â”‚ â€¢ Apply sorting     â”‚                                       â”‚
â”‚   â”‚ â€¢ Execute search    â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚            â”‚                                                    â”‚
â”‚            â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚    Elasticsearch    â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ Multi-match query:  â”‚                                       â”‚
â”‚   â”‚ â€¢ name^3            â”‚  (boosted)                            â”‚
â”‚   â”‚ â€¢ description^2     â”‚  (boosted)                            â”‚
â”‚   â”‚ â€¢ brand^2           â”‚  (boosted)                            â”‚
â”‚   â”‚ â€¢ tags              â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ Filters:            â”‚                                       â”‚
â”‚   â”‚ â€¢ price range       â”‚                                       â”‚
â”‚   â”‚ â€¢ category          â”‚                                       â”‚
â”‚   â”‚ â€¢ brand             â”‚                                       â”‚
â”‚   â”‚ â€¢ rating            â”‚                                       â”‚
â”‚   â”‚ â€¢ in stock          â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Sync Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MongoDB â†’ Elasticsearch Sync                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Product Changes in MongoDB                                    â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Create Product â”€â”€â–º syncProduct() â”€â”€â–º ES Index        â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Update Product â”€â”€â–º syncProduct() â”€â”€â–º ES Update       â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Delete Product â”€â”€â–º removeProduct() â”€â”€â–º ES Delete     â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€â–º Rating Change â”€â”€â–º updateProductRating() â”€â”€â–º ES Updateâ”‚
â”‚                                                                 â”‚
â”‚   Admin Manual Sync                                             â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Full Sync â”€â”€â–º syncAllProducts() â”€â”€â–º Reindex All      â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â–º Single Product â”€â”€â–º syncProductById() â”€â”€â–º ES Update   â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€â–º Category Reindex â”€â”€â–º reindexCategory() â”€â”€â–º ES Update â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Review System Architecture

### Review Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REVIEW FLOW                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   User creates review                                           â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚   â”‚ ReviewControllerâ”‚                                           â”‚
â”‚   â”‚ POST /api/reviewsâ”‚                                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚            â”‚                                                    â”‚
â”‚            â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚   ReviewService     â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 1. Verify product   â”‚â”€â”€â”€â”€â”€â”€â”€â–º MongoDB (Products)            â”‚
â”‚   â”‚    exists           â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 2. Check duplicate  â”‚â”€â”€â”€â”€â”€â”€â”€â–º PostgreSQL (Reviews)          â”‚
â”‚   â”‚    review           â”‚                                       â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 3. Verify purchase  â”‚â”€â”€â”€â”€â”€â”€â”€â–º PostgreSQL (Orders)           â”‚
â”‚   â”‚    (for badge)      â”‚         - Check DELIVERED orders      â”‚
â”‚   â”‚                     â”‚         - Match product ID            â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 4. Create review    â”‚â”€â”€â”€â”€â”€â”€â”€â–º PostgreSQL (Reviews)          â”‚
â”‚   â”‚                     â”‚                                       â”‚
â”‚   â”‚ 5. Update rating    â”‚â”€â”€â”€â”€â”€â”€â”€â–º ProductSyncService            â”‚
â”‚   â”‚    in search index  â”‚         - MongoDB (averageRating)     â”‚
â”‚   â”‚                     â”‚         - Elasticsearch (update)      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Verified Purchase Logic
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              VERIFIED PURCHASE DETERMINATION                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   When user submits review:                                     â”‚
â”‚                                                                 â”‚
â”‚   1. Query: Find user's DELIVERED orders                        â”‚
â”‚      SELECT * FROM orders                                       â”‚
â”‚      WHERE user_id = :userId AND status = 'DELIVERED'           â”‚
â”‚                                                                 â”‚
â”‚   2. For each order, check if product exists in order_items     â”‚
â”‚      SELECT * FROM order_items                                  â”‚
â”‚      WHERE order_id = :orderId AND product_id = :productId      â”‚
â”‚                                                                 â”‚
â”‚   3. If found:                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚      â”‚ verifiedPurchase = true                 â”‚                â”‚
â”‚      â”‚ orderNumber = found order's number      â”‚                â”‚
â”‚      â”‚ Badge: âœ“ Verified Purchase              â”‚                â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                 â”‚
â”‚   4. If not found:                                              â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚      â”‚ verifiedPurchase = false                â”‚                â”‚
â”‚      â”‚ orderNumber = null                      â”‚                â”‚
â”‚      â”‚ No badge displayed                      â”‚                â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Payment Flow Architecture

### Payment Intent Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PAYMENT FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   1. Place Order (POST /api/checkout/place-order)               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â€¢ Create order with status PENDING                      â”‚  â”‚
â”‚   â”‚  â€¢ Set payment_status to PENDING                         â”‚  â”‚
â”‚   â”‚  â€¢ Stock NOT reduced yet                                 â”‚  â”‚
â”‚   â”‚  â€¢ Cart cleared                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   2. Create Payment Intent (POST /api/payments/create-intent)   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â€¢ Call Stripe PaymentIntent.create()                    â”‚  â”‚
â”‚   â”‚  â€¢ Store Payment record in PostgreSQL                    â”‚  â”‚
â”‚   â”‚  â€¢ Update order with stripePaymentIntentId               â”‚  â”‚
â”‚   â”‚  â€¢ Set payment_status to AWAITING_PAYMENT                â”‚  â”‚
â”‚   â”‚  â€¢ Return clientSecret to frontend                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   3. Frontend Payment Confirmation (Stripe.js)                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  stripe.confirmCardPayment(clientSecret, {               â”‚  â”‚
â”‚   â”‚    payment_method: { card: cardElement }                 â”‚  â”‚
â”‚   â”‚  });                                                     â”‚  â”‚
â”‚   â”‚  â€¢ User enters card details                              â”‚  â”‚
â”‚   â”‚  â€¢ Stripe handles 3D Secure if required                  â”‚  â”‚
â”‚   â”‚  â€¢ Payment processed by Stripe                           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   4. Webhook Notification (POST /api/webhooks/stripe)           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â€¢ Stripe sends payment_intent.succeeded                 â”‚  â”‚
â”‚   â”‚  â€¢ Verify webhook signature                              â”‚  â”‚
â”‚   â”‚  â€¢ Update Payment record (PAID, chargeId, receiptUrl)    â”‚  â”‚
â”‚   â”‚  â€¢ Update Order (CONFIRMED, paidAt)                      â”‚  â”‚
â”‚   â”‚  â€¢ REDUCE STOCK NOW                                      â”‚  â”‚
â”‚   â”‚  â€¢ ðŸ“§ Send order confirmation email ðŸ†•                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why Webhooks?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                WHY WEBHOOKS ARE CRITICAL                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Without Webhooks (UNRELIABLE):                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  User â†’ Stripe â†’ Success â†’ Redirect â†’ Your Server      â”‚  â”‚
â”‚  â”‚                      â†“                                 â”‚  â”‚
â”‚  â”‚              User closes browser                       â”‚  â”‚
â”‚  â”‚              Network fails                             â”‚  â”‚
â”‚  â”‚              âŒ Payment received but order not updated â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  With Webhooks (RELIABLE):                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Stripe â†’ Webhook â†’ Your Server                        â”‚  â”‚
â”‚  â”‚    â”‚                                                   â”‚  â”‚
â”‚  â”‚    â””â”€â”€ Guaranteed delivery (with retries)              â”‚  â”‚
â”‚  â”‚    â””â”€â”€ Signature verification for security             â”‚  â”‚
â”‚  â”‚    â””â”€â”€ Source of truth for payment status              â”‚  â”‚
â”‚  â”‚    âœ… Payment always properly recorded                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Refund Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       REFUND FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   1. Check Eligibility                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â€¢ Payment status must be PAID                           â”‚  â”‚
â”‚   â”‚  â€¢ Within refund window (30 days default)                â”‚  â”‚
â”‚   â”‚  â€¢ Has refundable amount remaining                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   2. Process Refund (POST /api/admin/payments/refund)           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â€¢ Call Stripe Refund.create()                           â”‚  â”‚
â”‚   â”‚  â€¢ Update Payment record (amountRefunded, status)        â”‚  â”‚
â”‚   â”‚  â€¢ Update Order (status, amountRefunded)                 â”‚  â”‚
â”‚   â”‚  â€¢ Optionally restore stock                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚               â–¼                             â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚   Partial Refund    â”‚      â”‚    Full Refund      â”‚          â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚      â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚          â”‚
â”‚   â”‚   Status: PARTIAL   â”‚      â”‚   Status: REFUNDED  â”‚          â”‚
â”‚   â”‚   More refundable   â”‚      â”‚   Order: CANCELLED  â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Order Status State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PENDING   â”‚ â—„â”€â”€ Order Created
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚           â”‚
              â–¼            â–¼           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
        â”‚CANCELLED â”‚ â”‚CONFIRMED â”‚      â”‚ (After payment)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚  ðŸ“§ Order Confirmation ðŸ†•
                          â”‚            â”‚
                          â–¼            â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
                   â”‚ PROCESSING â”‚      â”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
                         â”‚             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
            â”‚            â”‚         â”‚   â”‚
            â–¼            â–¼         â”‚   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
      â”‚CANCELLED â”‚ â”‚  SHIPPED â”‚    â”‚   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
       ðŸ“§ Cancel ðŸ†•     â”‚  ðŸ“§ Ship ðŸ†•â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
              â”‚         â”‚         â”‚â”‚   â”‚
              â–¼         â–¼         â”‚â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚   â”‚
        â”‚DELIVERED â”‚ â”‚ RETURNED â”‚ â”‚â”‚   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚â”‚   â”‚
      ðŸ“§ Deliver ðŸ†•      â”‚       â”‚â”‚   â”‚
                          â–¼       â”‚â”‚   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚   â”‚
                    â”‚ REFUNDED â”‚â—„â”€â”´â”´â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Payment Status State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PENDING   â”‚ â—„â”€â”€ Order Created
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   AWAITING_PAYMENT    â”‚ â—„â”€â”€ Payment Intent Created
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚            â”‚
              â–¼            â–¼            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  FAILED  â”‚ â”‚   PAID   â”‚ â”‚CANCELLED â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                       â”‚
              â–¼                       â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚PARTIALLY_REFUNDEDâ”‚      â”‚ REFUNDED â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€ â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ REFUNDED â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cross-Database Transaction Handling

Since we use multiple databases, we handle distributed transactions carefully:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Payment Success Transaction (Webhook)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  @Transactional (PostgreSQL)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. Update Payment â†’ 2. Update Order â†’ 3. Reduce Stock  â”‚   â”‚
â”‚  â”‚     (PostgreSQL)       (PostgreSQL)       (MongoDB)     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  4. Send Confirmation Email (@Async) ðŸ†•                 â”‚   â”‚
â”‚  â”‚     (Non-blocking, failure doesn't affect transaction)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                 â”‚
â”‚                              â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  If MongoDB stock reduction fails:                      â”‚   â”‚
â”‚  â”‚  - PostgreSQL changes are rolled back automatically     â”‚   â”‚
â”‚  â”‚  - Webhook returns error (Stripe will retry)            â”‚   â”‚
â”‚  â”‚  - Log error for manual investigation                   â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  If Email sending fails:                                â”‚   â”‚
â”‚  â”‚  - Order still processed successfully                   â”‚   â”‚
â”‚  â”‚  - Email failure logged to email_logs table             â”‚   â”‚
â”‚  â”‚  - Does NOT affect order/payment transaction            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Compensation Pattern
For refunds, we use compensation:
```
Process Refund:
1. Call Stripe Refund API (external)
2. Update Payment record (PostgreSQL)
3. Update Order status (PostgreSQL)
4. Restore stock in MongoDB (optional, compensation)
5. Send cancellation email (@Async) ðŸ†•
6. All succeed â†’ Success
7. Stock restore fails â†’ Log error, manual intervention needed
8. Email fails â†’ Logged, doesn't affect refund
```

---

## Security Architecture

### Authentication Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1. Login     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Server  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                  â”‚
     2. JWT Token                 â”‚
â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  3. Request+JWT  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Server  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                   â”‚
     4. Protected Resource         â”‚
â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Webhook Security
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Webhook + Signature   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stripe  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Server  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                   Verify Signature
                                   using Webhook Secret
                                          â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                       â”‚
                          Valid                   Invalid
                              â”‚                       â”‚
                              â–¼                       â–¼
                        Process Event           Reject (401)
```

### Authorization Levels
| Role | Permissions |
|------|-------------|
| PUBLIC | View products, categories, search, reviews (read), Stripe webhooks |
| CUSTOMER | Cart, wishlist, orders, addresses, payments, reviews (write) |
| ADMIN | All + product/category CRUD + order/payment management + refunds + search sync + dashboard ðŸ†• + reports ðŸ†• + user management ðŸ†• |

---

## Configuration Management

```yaml
shopzone:
  order:
    tax-rate: 0.08                    # 8% tax
    free-shipping-threshold: 50.00    # Free shipping over $50
    flat-shipping-rate: 5.99          # Otherwise $5.99
    cancellation-window-hours: 24     # Cancel within 24hrs
  
  payment:
    refund-window-days: 30            # Refund within 30 days

stripe:
  secret-key: ${STRIPE_SECRET_KEY}
  public-key: ${STRIPE_PUBLIC_KEY}
  webhook-secret: ${STRIPE_WEBHOOK_SECRET}
  currency: usd

spring:
  elasticsearch:
    uris: http://localhost:9200
    connection-timeout: 5s
    socket-timeout: 30s

  mail:                               # ðŸ†• Week 7
    host: sandbox.smtp.mailtrap.io
    port: 2525
    username: ${MAILTRAP_USERNAME}
    password: ${MAILTRAP_PASSWORD}
    properties:
      mail.smtp.auth: true
      mail.smtp.starttls.enable: true
```

---

## Design Patterns Used

### 1. Repository Pattern
- Abstracts data access
- Different implementations per database
- Easy to test with mocks

### 2. DTO Pattern
- Separates internal models from API contracts
- Request DTOs for validation
- Response DTOs for formatting

### 3. Service Layer Pattern
- Business logic centralized
- Controllers are thin
- Services can call other services

### 4. Factory Method Pattern
- `fromEntity()` methods in DTOs
- Clean entity-to-DTO conversion

### 5. Snapshot Pattern
- Order preserves address/product data at order time
- Protects against future changes
- Maintains historical accuracy

### 6. State Machine Pattern
- Order status transitions validated
- Payment status transitions validated
- Invalid transitions rejected

### 7. Webhook Handler Pattern
- Idempotent event processing
- Signature verification
- Event type routing

### 8. Sync Service Pattern
- Keeps Elasticsearch in sync with MongoDB
- Handles create/update/delete events
- Supports full and incremental sync

### 9. Template Method Pattern ðŸ†• (Week 7)
- Thymeleaf templates for email rendering
- Consistent email structure with variable content
- Separation of email design from business logic

### 10. Async Processing Pattern ðŸ†• (Week 7)
- Email sending is non-blocking (@Async)
- Doesn't affect main transaction flow
- Failures logged independently

---

## Future Architecture (Microservices - Phase 3+)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Gateway                              â”‚
â”‚                    (Spring Cloud Gateway)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼          â–¼           â–¼           â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User   â”‚ â”‚ Product  â”‚ â”‚   Cart   â”‚ â”‚  Order   â”‚ â”‚ Payment  â”‚
â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Apache Kafka    â”‚
                    â”‚   (Event Bus)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```